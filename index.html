<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AOA Student Metrics</title>
    
    <!-- FIX: Load Tailwind CSS CDN first -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for advanced charting (Line Graph) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script> 
    
    <!-- Tailwind Configuration for Custom Colors (Dark Blue and Gold) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#192F59', // Deep Dark Blue
                        gold: '#FFC72C',    // Bright Gold Accent
                        // We keep red and green for the chart as they represent performance status
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Custom styles for the input textareas to look like sheet columns */
        textarea {
            resize: none;
            font-family: monospace;
            min-height: 250px;
        }
        .summary-card {
            /* Using a subtle shadow and dark blue border for definition */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(25, 47, 89, 0.1); /* Light Primary Border */
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-10 font-sans">

    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-primary mb-2">AOA Student Metrics</h1>
        <p class="text-gray-600 mb-2">The summary metrics and charts update instantly by counting events.</p>
        <!-- Dynamic Date/Time Display -->
        <p id="currentDateTime" class="text-sm text-gray-500 mb-8 font-semibold italic">Last Updated: Loading...</p>

        <!-- Main Grid Layout: Changed Input to col-span-1 and Summary/Charts to col-span-2 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            
            <!-- 1. Data Input Columns (LHS) - Takes 1/3 on large screens -->
            <div class="lg:col-span-1 space-y-8">
                
                <!-- Cancellations Input (Block Separated & Filtered) -->
                <div>
                    <label for="cancellationInput" class="block text-lg font-semibold text-primary mb-2">CANCELLATIONS</label>
                    <p class="text-xs text-gray-500 mb-1">Each block counts as one event. Classified as Sick ("student sick", "**ill**", "**fatigue**", "**not feeling well**", "**unwell**") or Request ("student request", "**out of town**", "**vacation**").</p>
                    <textarea id="cancellationInput" oninput="calculateMetrics()" placeholder="Paste multi-line cancellation data here" class="w-full p-4 border-2 border-primary/30 rounded-lg focus:ring-red-500 focus:border-red-500 text-sm shadow-inner"></textarea>
                </div>

                <!-- Completed Flights Input (Pattern Counted - Unfiltered) -->
                <div>
                    <label for="completedInput" class="block text-lg font-semibold text-primary mb-2">COMPLETED SESSIONS</label>
                    <p class="text-xs text-gray-500 mb-1">Counts every line containing a "PIC...Rental" signature. Sessions are classified as **Flights** if they contain "**172**" anywhere on that line.</p>
                    <textarea id="completedInput" oninput="calculateMetrics()" placeholder="Paste flight record data here" class="w-full p-4 border-2 border-primary/30 rounded-lg focus:ring-green-500 focus:border-green-500 text-sm shadow-inner"></textarea>
                </div>
            </div>

            <!-- 2. Summary & Charts (RHS) - Takes 2/3 on large screens -->
            <div class="lg:col-span-2 space-y-8">
                
                <!-- Summary Metrics (Full width of the 2/3 column) -->
                <div class="bg-white p-6 rounded-xl summary-card">
                    <h2 class="text-xl font-bold text-primary mb-4 border-b pb-2">SUMMARY METRICS</h2>
                    
                    <div class="space-y-3">
                        
                        <!-- Completed Flights (172-sessions) -->
                        <div class="flex justify-between items-center py-2 border-b">
                            <span class="text-gray-700">Completed Flights (172-sessions)</span>
                            <span id="flightCount" class="font-bold text-green-600 text-xl">0</span>
                        </div>

                        <!-- Completed Ground Sessions (No 172-sessions) -->
                        <div class="flex justify-between items-center py-2 border-b">
                            <span class="text-gray-700">Completed Ground Sessions</span>
                            <span id="groundCount" class="font-bold text-gold text-xl">0</span>
                        </div>
                        
                        <!-- NEW: Total Cancellations Header (now displays the sum of included reasons) -->
                        <div class="flex justify-between items-center py-2 border-b bg-red-50/50 rounded-md">
                            <span class="font-semibold text-red-700">TOTAL CANCELLATIONS</span>
                            <span id="cancellationCount" class="font-extrabold text-red-700 text-xl">0</span>
                        </div>
                        
                        <!-- NEW: Breakdown - Student Sick -->
                        <div class="flex justify-between items-center py-1 border-b">
                            <span class="text-gray-600 ml-3 text-sm">Reason: Student Sick</span>
                            <span id="sickCount" class="font-bold text-red-500 text-base">0</span>
                        </div>

                        <!-- NEW: Breakdown - Student Request -->
                        <div class="flex justify-between items-center py-1 border-b">
                            <span class="text-gray-600 ml-3 text-sm">Reason: Student Request</span>
                            <span id="requestCount" class="font-bold text-red-500 text-base">0</span>
                        </div>

                        <!-- Cancellations Filtered Out (EXCLUDED COUNT) -->
                        <div class="flex justify-between items-center py-2 border-b border-dashed">
                            <span class="text-sm text-gray-500 italic">Cancellations Filtered Out</span>
                            <span id="cancellationFilteredOutCount" class="font-medium text-gray-400 text-lg">0</span>
                        </div>
                        
                        <!-- TOTAL SESSIONS (remains the grand total) -->
                        <div class="flex justify-between items-center py-3 mt-2 border-y-4 border-primary/70 bg-blue-50/50">
                            <span class="font-extrabold text-primary text-lg">TOTAL SESSIONS</span>
                            <span id="totalCount" class="font-extrabold text-primary text-2xl">0</span>
                        </div>

                        <!-- Completion Rate -->
                        <div class="flex justify-between items-center pt-2">
                            <span class="text-gray-700 font-semibold">Completion Rate</span>
                            <span id="completionRate" class="font-extrabold text-gold text-2xl">0%</span>
                        </div>

                        <!-- Average Flights Per Week -->
                        <div class="flex justify-between items-center pt-2 border-t border-primary/20 mt-4">
                            <span class="text-gray-700 font-semibold">AVG Sessions Per Week</span>
                            <span id="weeklyAverage" class="font-extrabold text-primary text-2xl">0.0</span>
                        </div>

                    </div>
                </div>

                <!-- NEW GRID CONTAINER: Charts Side-by-Side on Medium/Large Screens -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-8">
                    
                    <!-- Line Chart for Weekly Trend (LEFT) -->
                    <div class="bg-white p-6 rounded-xl summary-card">
                        <h2 class="text-xl font-bold text-primary mb-4 border-b pb-2">Weekly Session Trend</h2>
                        <canvas id="lineChart" class="w-full" style="max-height: 300px;"></canvas>
                    </div>

                    <!-- Pie Chart (RIGHT) -->
                    <div class="bg-white p-6 rounded-xl summary-card">
                        <h2 class="text-xl font-bold text-primary mb-4 border-b pb-2">Performance Distribution</h2>
                        <canvas id="pieChart" class="w-full" style="max-height: 300px;"></canvas>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <script>
        // Constants for the pie chart colors (Kept Green/Red for clear performance status)
        const COLORS = {
            COMPLETED: '#10B981', // Green-500 (Success)
            CANCELLED: '#EF4444', // Red-500 (Warning/Danger)
            BG: '#F9FAFB'
        };

        // DOM elements
        const completedInput = document.getElementById('completedInput');
        const cancellationInput = document.getElementById('cancellationInput');
        
        // DOM elements for the split counts
        const flightCountEl = document.getElementById('flightCount');
        const groundCountEl = document.getElementById('groundCount');

        // NEW DOM elements for Cancellation Breakdown
        const sickCountEl = document.getElementById('sickCount');
        const requestCountEl = document.getElementById('requestCount');

        const cancellationCountEl = document.getElementById('cancellationCount');
        const totalCountEl = document.getElementById('totalCount');
        const completionRateEl = document.getElementById('completionRate');
        const chartCanvas = document.getElementById('pieChart');
        const ctx = chartCanvas.getContext('2d');
        const cancellationFilteredOutCountEl = document.getElementById('cancellationFilteredOutCount'); 
        const weeklyAverageEl = document.getElementById('weeklyAverage');
        
        // Time tracking element
        const dateTimeElement = document.getElementById('currentDateTime');

        // Chart.js instance variable
        let lineChartInstance = null;
        let pieChartInstance = null; 

        /**
         * Updates the designated HTML element with the current date and time.
         */
        function updateDateTime() {
            const now = new Date();
            // Use toLocaleString for a user-friendly, localized format
            const formattedDateTime = now.toLocaleString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
            
            if (dateTimeElement) {
                // Update the text to show the time
                dateTimeElement.textContent = `Last Calculated: ${formattedDateTime}`;
            }
        }

        /**
         * Counts sessions into 'flight' (contains 172) and 'ground' (no 172) types.
         * @param {HTMLTextAreaElement} inputElement The completed sessions input.
         * @returns {object} { flightCount: number, groundCount: number }
         */
        function countCompletedTypes(inputElement) {
            const value = inputElement.value;
            let flightCount = 0;
            let groundCount = 0;

            if (value.length === 0) {
                return { flightCount: 0, groundCount: 0 };
            }
            
            // Regex to identify a line containing a completed session signature: PIC + 6-digits + Rental
            const picRentalRegex = /PIC.*?\d{6}.*?Rental/i;

            const sessionLines = value.split('\n');

            for (const line of sessionLines) {
                const lineLower = line.toLowerCase();
                
                // 1. Check if the line is a completed session entry
                if (picRentalRegex.test(lineLower)) {
                    // 2. If it is a completed session, classify it based on '172' in the entire line.
                    if (lineLower.includes("172")) {
                        flightCount++;
                    } else {
                        groundCount++;
                    }
                }
            }

            return { flightCount, groundCount };
        }


        /**
         * Counts event blocks separated by blank lines and breaks down the included counts.
         * @param {HTMLTextAreaElement} inputElement 
         * @returns {object} An object containing { sickCount, requestCount, excludedCount }.
         */
        function countFilteredBlockEvents(inputElement) {
            const value = inputElement.value.trim();
            if (value.length === 0) {
                return { sickCount: 0, requestCount: 0, excludedCount: 0 };
            }
            // Split by one or more blank lines (newline followed by optional whitespace and another newline)
            const blocks = value.split(/\n\s*\n/).filter(b => b.trim().length > 0); // Filter empty blocks early

            let sickCount = 0;
            let requestCount = 0;
            let excludedCount = 0;

            // Updated keywords for classification
            const SICK_KEYWORDS = ["student sick", "ill", "fatigue", "not feeling well", "unwell"];
            const REQUEST_KEYWORDS = ["student request", "out of town", "vacation"];
            
            // Iterate over all non-empty blocks
            for (const blockContent of blocks) {
                const contentLower = blockContent.toLowerCase();
                
                // Check for Sick keywords
                const isSick = SICK_KEYWORDS.some(keyword => contentLower.includes(keyword));
                
                // Check for Request keywords
                const isRequest = REQUEST_KEYWORDS.some(keyword => contentLower.includes(keyword));

                if (isSick || isRequest) {
                    // CRITICAL: Prioritize SICK classification if multiple keywords are present in the same block.
                    // This ensures a block is counted only once under the most severe category.
                    if (isSick) {
                        sickCount++;
                    } else if (isRequest) { // Only count as request if not already counted as sick
                        requestCount++;
                    }
                } else {
                    excludedCount++;
                }
            }
            // The total included count is sickCount + requestCount, which is handled in calculateMetrics.
            return { sickCount, requestCount, excludedCount };
        }

        /**
         * Calculates the average weekly flights based on the date range in the input.
         * @param {number} completedTotal 
         * @param {HTMLTextAreaElement} inputElement 
         * @returns {number} The calculated weekly average.
         */
        function calculateWeeklyAverage(completedTotal, inputElement) {
            if (completedTotal === 0) return 0.0;

            const value = inputElement.value;
            // Regex to capture common date formats (e.g., MM/DD/YYYY, YYYY-MM-DD, M-D-YY)
            const dateRegex = /(\d{1,2}[-/]\d{1,2}[-/]\d{2,4})|(\d{4}[-/]\d{1,2}[-/]\d{1,2})/g;
            const dateMatches = value.match(dateRegex);

            if (!dateMatches || dateMatches.length === 0) {
                return completedTotal; // Fallback: Assume 1 week if dates aren't found
            }

            // Convert date strings to Date objects, filtering out invalid dates
            const validDates = dateMatches
                .map(dateStr => new Date(dateStr))
                .filter(date => !isNaN(date.getTime()));

            if (validDates.length === 0) {
                 return completedTotal; // Fallback: Assume 1 week if dates were unparseable
            }

            const minDate = new Date(Math.min(...validDates));
            const maxDate = new Date(Math.max(...validDates));
            
            const oneWeekInMs = 1000 * 60 * 60 * 24 * 7;
            const diffTime = Math.abs(maxDate.getTime() - minDate.getTime());
            
            let numberOfWeeks = diffTime / oneWeekInMs;

            // Ensure the denominator is at least 1 week if the sessions happened on the same day/week.
            if (numberOfWeeks < 1) {
                numberOfWeeks = 1;
            }

            // Calculate the average
            return completedTotal / numberOfWeeks;
        }

        /**
         * Groups completed sessions by week number (Sunday start) and distributes the total count.
         * @param {number} completedTotal 
         * @param {HTMLTextAreaElement} inputElement 
         * @returns {object} An object containing { labels: string[], data: number[] }.
         */
        function groupDataByWeek(completedTotal, inputElement) {
            const value = inputElement.value;
            // Regex to capture common date formats
            const dateRegex = /(\d{1,2}[-/]\d{1,2}[-/]\d{2,4})|(\d{4}[-/]\d{1,2}[-/]\d{1,2})/g;
            const dateMatches = value.match(dateRegex);
            const weeklyData = {};

            if (!dateMatches || completedTotal === 0) return { labels: [], data: [] };

            const validDates = dateMatches
                .map(dateStr => new Date(dateStr))
                .filter(date => !isNaN(date.getTime()));

            if (validDates.length === 0) return { labels: [], data: [] };
            
            for (const date of validDates) {
                // Find the start of the week (Sunday) for grouping
                const dayOfWeek = date.getDay(); // 0 for Sunday, 6 for Saturday
                const weekStartDate = new Date(date);
                weekStartDate.setDate(date.getDate() - dayOfWeek);
                
                // Format the date as a consistent week label (e.g., 'MM/DD')
                const label = weekStartDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                if (weeklyData[label]) {
                    weeklyData[label]++; // Count the date density in that week
                } else {
                    weeklyData[label] = 1;
                }
            }

            // --- Distribution Logic ---
            // Distribute the total 'completedTotal' proportionally based on date density.
            const totalDateDensity = Object.values(weeklyData).reduce((sum, count) => sum + count, 0);
            const weeklySessionCounts = {};
            
            if (totalDateDensity > 0) {
                for (const label in weeklyData) {
                    const proportion = weeklyData[label] / totalDateDensity;
                    // Assign a proportional number of completed sessions to this week.
                    weeklySessionCounts[label] = Math.round(completedTotal * proportion);
                }
            } else {
                return { labels: [], data: [] };
            }
            
            // Sort labels based on their date value
            const sortedLabels = Object.keys(weeklySessionCounts).sort((a, b) => new Date(a) - new Date(b));
            const data = sortedLabels.map(label => weeklySessionCounts[label]);

            return { labels: sortedLabels, data: data };
        }

        /**
         * Draws the line chart using Chart.js
         * @param {object} weeklyTrendData { labels: string[], data: number[] }
         */
        function drawLineChart(weeklyTrendData) {
            const canvas = document.getElementById('lineChart');
            if (!canvas) return;
            
            const ctxLine = canvas.getContext('2d');

            // Destroy old chart instance if it exists
            if (lineChartInstance) {
                lineChartInstance.destroy();
            }
            
            const { labels, data } = weeklyTrendData;

            lineChartInstance = new Chart(ctxLine, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Completed Sessions',
                        data: data,
                        borderColor: COLORS.COMPLETED, // Green for Completed
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        tension: 0.3, // Smooth lines
                        borderWidth: 3,
                        fill: true,
                        pointRadius: 5,
                        pointBackgroundColor: '#192F59', // Dark Blue points
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Allows max-height in CSS to work
                    plugins: {
                        legend: {
                            display: false,
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Sessions Completed'
                            },
                            ticks: {
                                // Ensure y-axis labels are integers
                                callback: function(value) { if (value % 1 === 0) { return value; } return null; }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Week Starting Date'
                            }
                        }
                    }
                }
            });
        }

        /**
         * The main function to calculate and update all metrics and the chart.
         */
        function calculateMetrics() {
            // Get flight and ground counts
            const sessionCounts = countCompletedTypes(completedInput);
            const completedFlights = sessionCounts.flightCount;
            const completedGrounds = sessionCounts.groundCount;
            const completedTotal = completedFlights + completedGrounds; 
            
            // NEW: Get cancellation breakdown
            const cancellationResults = countFilteredBlockEvents(cancellationInput); 
            const sickIncluded = cancellationResults.sickCount;
            const requestIncluded = cancellationResults.requestCount;
            const cancelledExcluded = cancellationResults.excludedCount;
            
            // Calculate total included cancellations
            const cancelledIncluded = sickIncluded + requestIncluded;

            const total = completedTotal + cancelledIncluded; // Total sessions (completed + cancelled)
            
            // Calculate Metrics
            const weeklyAverage = calculateWeeklyAverage(completedTotal, completedInput);
            const weeklyTrendData = groupDataByWeek(completedTotal, completedInput); 
            
            // Update Summary Table 
            flightCountEl.textContent = completedFlights;
            groundCountEl.textContent = completedGrounds;

            // Update new breakdown metrics
            sickCountEl.textContent = sickIncluded;
            requestCountEl.textContent = requestIncluded;

            cancellationCountEl.textContent = cancelledIncluded; // Update the total cancellation header
            cancellationFilteredOutCountEl.textContent = cancelledExcluded; 
            totalCountEl.textContent = total;
            weeklyAverageEl.textContent = weeklyAverage.toFixed(1); // Update new metric
            
            // Update Completion Rate 
            let rate = 0;
            if (total > 0) {
                rate = (completedTotal / total) * 100;
            }
            completionRateEl.textContent = `${rate.toFixed(1)}%`;

            // Draw Charts
            drawPieChart(completedTotal, cancelledIncluded);
            drawLineChart(weeklyTrendData); // Draw the new line chart
        }

        /**
         * Counts cancellation events using the filtered block counter.
         */
        function countCancellationEvents(inputElement) {
            return countFilteredBlockEvents(inputElement);
        }

        /**
         * Draws the pie chart based on completed and cancelled counts.
         * @param {number} completed 
         * @param {number} cancelled 
         */
        function drawPieChart(completed, cancelled) {
            const total = completed + cancelled;
            
            // Clear the canvas
            ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);

            const center = chartCanvas.width / 2;
            const radius = Math.min(chartCanvas.width, chartCanvas.height) / 2 - 10;
            
            if (total === 0) {
                drawCircle(0, Math.PI * 2, COLORS.BG);
                drawText('No Data', center, center, '#6B7280');
                return;
            }

            let currentAngle = 0;

            // 1. Draw Completed Slice (Green)
            const completedRatio = completed / total;
            const completedAngle = completedRatio * Math.PI * 2;
            drawSlice(currentAngle, currentAngle + completedAngle, COLORS.COMPLETED);
            currentAngle += completedAngle;

            // 2. Draw Cancelled Slice (Red)
            const cancelledRatio = cancelled / total;
            const cancelledAngle = cancelledRatio * Math.PI * 2;
            drawSlice(currentAngle, currentAngle + cancelledAngle, COLORS.CANCELLED);

            // Helper functions (defined locally to use 'center' and 'radius')
            function drawSlice(startAngle, endAngle, color) {
                ctx.beginPath();
                ctx.moveTo(center, center);
                ctx.arc(center, center, radius, startAngle, endAngle);
                ctx.closePath();
                ctx.fillStyle = color;
                ctx.fill();
            }

            function drawText(text, x, y, color) {
                ctx.font = '20px sans-serif';
                ctx.fillStyle = color;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(text, x, y);
            }
            
            function drawCircle(startAngle, endAngle, color) {
                ctx.beginPath();
                ctx.arc(center, center, radius, startAngle, endAngle);
                ctx.closePath();
                ctx.fillStyle = color;
                ctx.fill();
            }
        }

        // Initial setup on load
        window.onload = () => {
            const size = 300;
            chartCanvas.width = size;
            chartCanvas.height = size;
            
            // --- TIME LOGIC START ---
            updateDateTime(); // Initial call
            setInterval(updateDateTime, 1000); // Update every 1 second
            // --- TIME LOGIC END ---

            calculateMetrics();
        };
    </script>
</body>
</html>
